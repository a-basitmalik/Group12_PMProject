<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>PM Standards Explorer ‚Äî Project Aurora</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/elasticlunr/elasticlunr.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>

  <style>
    /* ==============================================
       PROFESSIONAL REDESIGN: MODERN, CLEAN, USER-FRIENDLY
       ============================================== */

    :root {
      /* Professional color palette */
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --primary-light: #4895ef;
      --secondary: #7209b7;
      --accent: #f72585;
      --success: #4cc9f0;
      
      /* Neutral tones */
      --bg-primary: #0f1419;
      --bg-secondary: #1a2026;
      --bg-surface: #242c33;
      --bg-card: #2a333c;
      
      /* Text colors */
      --text-primary: #f8fafc;
      --text-secondary: #cbd5e1;
      --text-muted: #94a3b8;
      
      /* UI elements */
      --border: rgba(255, 255, 255, 0.08);
      --border-light: rgba(255, 255, 255, 0.12);
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.4);
      --radius: 8px;
      --radius-lg: 12px;
      --transition: all 0.2s ease;
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      margin: 0;
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      color: var(--text-secondary);
      background-color: var(--bg-primary);
      line-height: 1.5;
    }

    /* Layout */
    .app-container {
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar Navigation */
    .sidebar {
      width: 260px;
      background: var(--bg-secondary);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
      z-index: 100;
    }

    .sidebar-header {
      padding: 24px 20px 16px;
      border-bottom: 1px solid var(--border);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      color: var(--text-primary);
      font-weight: 700;
      font-size: 18px;
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 14px;
    }

    .nav-section {
      padding: 20px 0;
    }

    .nav-title {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      padding: 0 20px 12px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      color: var(--text-secondary);
      text-decoration: none;
      transition: var(--transition);
      border-left: 3px solid transparent;
    }

    .nav-item:hover {
      background: rgba(255, 255, 255, 0.03);
      color: var(--text-primary);
    }

    .nav-item.active {
      background: rgba(67, 97, 238, 0.1);
      color: var(--primary-light);
      border-left-color: var(--primary);
    }

    .nav-icon {
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      margin-left: 260px;
      padding: 0;
      min-height: 100vh;
    }

    /* Top Bar */
    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 32px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 90;
    }

    .page-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0;
    }

    .user-actions {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      border-radius: var(--radius);
      font-weight: 500;
      font-size: 14px;
      cursor: pointer;
      transition: var(--transition);
      border: none;
      text-decoration: none;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
    }

    .btn-secondary {
      background: var(--bg-surface);
      color: var(--text-secondary);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--bg-card);
      color: var(--text-primary);
    }

    .btn-outline {
      background: transparent;
      color: var(--text-secondary);
      border: 1px solid var(--border);
    }

    .btn-outline:hover {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-primary);
    }

    /* Page Content */
    .page-content {
      padding: 32px;
      max-width: 1400px;
    }

    /* Card Components */
    .card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .card-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
    }

    .card-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card-body {
      padding: 24px;
    }

    .card-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--border);
      background: rgba(0, 0, 0, 0.1);
    }

    /* Grid Layout */
    .grid {
      display: grid;
      gap: 24px;
    }

    .grid-2 {
      grid-template-columns: repeat(2, 1fr);
    }

    .grid-3 {
      grid-template-columns: repeat(3, 1fr);
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .form-control {
      width: 100%;
      padding: 12px 16px;
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text-primary);
      font-size: 14px;
      transition: var(--transition);
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
    }

    /* Search Results */
    .search-results {
      max-height: 400px;
      overflow-y: auto;
    }

    .result-item {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      transition: var(--transition);
    }

    .result-item:hover {
      background: rgba(255, 255, 255, 0.03);
    }

    .result-title {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .result-meta {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .result-snippet {
      font-size: 14px;
      color: var(--text-secondary);
    }

    /* Document Viewer */
    .viewer-container {
      height: 500px;
      overflow-y: auto;
      background: var(--bg-surface);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      padding: 20px;
      font-size: 15px;
      line-height: 1.6;
    }

    /* Viewer Controls */
    .viewer-controls {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: var(--bg-surface);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .viewer-nav {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .page-indicator {
      font-size: 14px;
      color: var(--text-muted);
      min-width: 100px;
      text-align: center;
    }

    /* Comparison */
    .comparison-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }

    .comparison-box {
      height: 300px;
      overflow-y: auto;
      background: var(--bg-surface);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      padding: 16px;
      font-size: 14px;
      line-height: 1.5;
    }

    /* Dashboard Stats */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 24px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .stat-label {
      font-size: 14px;
      color: var(--text-muted);
    }

    /* Tabs */
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      margin-bottom: 24px;
    }

    .tab {
      padding: 12px 20px;
      font-weight: 500;
      color: var(--text-muted);
      cursor: pointer;
      transition: var(--transition);
      border-bottom: 2px solid transparent;
    }

    .tab.active {
      color: var(--primary-light);
      border-bottom-color: var(--primary);
    }

    .tab:hover:not(.active) {
      color: var(--text-secondary);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Utility Classes */
    .text-center { text-align: center; }
    .text-primary { color: var(--text-primary); }
    .text-muted { color: var(--text-muted); }
    .mb-0 { margin-bottom: 0; }
    .mb-1 { margin-bottom: 8px; }
    .mb-2 { margin-bottom: 16px; }
    .mb-3 { margin-bottom: 24px; }
    .mt-1 { margin-top: 8px; }
    .mt-2 { margin-top: 16px; }
    .mt-3 { margin-top: 24px; }
    .d-flex { display: flex; }
    .align-center { align-items: center; }
    .justify-between { justify-content: space-between; }
    .gap-1 { gap: 8px; }
    .gap-2 { gap: 16px; }
    .gap-3 { gap: 24px; }

    /* Scrollbar Styling */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-surface);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border-light);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    /* Document content styling */
    #bookContent {
      line-height: 1.6;
      font-size: 15px;
    }

    #bookContent mark {
      background: linear-gradient(90deg, rgba(167,121,255,0.3), rgba(14,208,226,0.2));
      padding: 2px 4px;
      border-radius: 4px;
      color: var(--text-primary);
      font-weight: 600;
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .grid-3 {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 992px) {
      .sidebar {
        width: 80px;
      }
      
      .sidebar-header .logo-text,
      .nav-item .nav-text,
      .nav-title {
        display: none;
      }
      
      .main-content {
        margin-left: 80px;
      }
      
      .comparison-container {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .grid-2,
      .grid-3 {
        grid-template-columns: 1fr;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .page-content {
        padding: 20px;
      }
      
      .top-bar {
        padding: 16px 20px;
      }
      
      .viewer-controls {
        flex-direction: column;
        align-items: stretch;
      }
    }

    /* Page-specific styles */
    .page {
      display: none;
    }
    
    .page.active {
      display: block;
    }
    
    /* Welcome page */
    .welcome-hero {
      text-align: center;
      padding: 60px 0;
      background: linear-gradient(135deg, var(--bg-secondary), var(--bg-primary));
      border-radius: var(--radius-lg);
      margin-bottom: 40px;
    }
    
    .welcome-title {
      font-size: 36px;
      font-weight: 800;
      color: var(--text-primary);
      margin-bottom: 16px;
    }
    
    .welcome-subtitle {
      font-size: 18px;
      color: var(--text-secondary);
      max-width: 600px;
      margin: 0 auto 32px;
    }
    
    .feature-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 24px;
      margin-top: 40px;
    }
    
    .feature-card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 24px;
      text-align: center;
      border: 1px solid var(--border);
      transition: var(--transition);
    }
    
    .feature-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-lg);
    }
    
    .feature-icon {
      width: 60px;
      height: 60px;
      background: rgba(67, 97, 238, 0.1);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 16px;
      color: var(--primary);
      font-size: 24px;
    }
    
    .feature-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }
    
    .feature-description {
      color: var(--text-secondary);
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar Navigation -->
    <nav class="sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <div class="logo-icon">PM</div>
          <span class="logo-text">Standards Explorer</span>
        </div>
      </div>
      
      <div class="nav-section">
        <div class="nav-title">Main</div>
        <a href="#" class="nav-item active" data-page="dashboard">
          <div class="nav-icon">üìä</div>
          <span class="nav-text">Dashboard</span>
        </a>
        <a href="#" class="nav-item" data-page="repository">
          <div class="nav-icon">üìÅ</div>
          <span class="nav-text">Repository</span>
        </a>
        <a href="#" class="nav-item" data-page="viewer">
          <div class="nav-icon">üìñ</div>
          <span class="nav-text">Document Viewer</span>
        </a>
        <a href="#" class="nav-item" data-page="search">
          <div class="nav-icon">üîç</div>
          <span class="nav-text">Search</span>
        </a>
        <a href="#" class="nav-item" data-page="compare">
          <div class="nav-icon">‚öñÔ∏è</div>
          <span class="nav-text">Compare</span>
        </a>
      </div>
      
      <div class="nav-section">
        <div class="nav-title">Tools</div>
        <a href="#" class="nav-item" data-page="process">
          <div class="nav-icon">üõ†Ô∏è</div>
          <span class="nav-text">Process Generator</span>
        </a>
        <a href="#" class="nav-item" data-page="scenarios">
          <div class="nav-icon">üéØ</div>
          <span class="nav-text">Scenarios</span>
        </a>
        <a href="#" class="nav-item" data-page="bookmarks">
          <div class="nav-icon">‚≠ê</div>
          <span class="nav-text">Bookmarks</span>
        </a>
      </div>
      
      <div class="nav-section">
        <div class="nav-title">Settings</div>
        <!-- <a href="#" class="nav-item" data-page="export">
          <div class="nav-icon">üì§</div>
          <span class="nav-text">Export</span>
        </a> -->
        <a href="#" class="nav-item" id="githubLink">
          <div class="nav-icon">üîó</div>
          <span class="nav-text">GitHub Repo</span>
        </a>
      </div>
    </nav>
    
    <!-- Main Content -->
    <main class="main-content">
      <!-- Top Bar -->
      <header class="top-bar">
        <h1 class="page-title" id="currentPageTitle">Dashboard</h1>
        <div class="user-actions">
          <button class="btn btn-outline" id="exportReadme">Export README</button>
          <button class="btn btn-primary" id="downloadWBS">Download WBS</button>
        </div>
      </header>
      
      <!-- Page Content -->
      <div class="page-content">
        <!-- Dashboard Page -->
        <div class="page active" id="dashboard">
          <div class="welcome-hero">
            <h1 class="welcome-title">PM Standards Explorer</h1>
            <p class="welcome-subtitle">A comprehensive tool for comparing project management standards, generating processes, and tailoring methodologies to your specific needs.</p>
            <div class="d-flex justify-center gap-2">
              <button class="btn btn-primary" data-page="repository" style="margin-left: 350px;">Get Started</button>
              <button class="btn btn-outline" data-page="scenarios">Explore Scenarios</button>
            </div>
          </div>
          
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value" id="docCount">0</div>
              <div class="stat-label">Standards Uploaded</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="bookmarkCount">0</div>
              <div class="stat-label">Bookmarks</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">3</div>
              <div class="stat-label">Scenario Templates</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="searchCount">0</div>
              <div class="stat-label">Search Results</div>
            </div>
          </div>
          
          <div class="grid grid-3">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">üìÅ Repository</h3>
              </div>
              <div class="card-body">
                <p class="text-muted">Upload and manage your PM standards documents (PDF, TXT, HTML).</p>
                <button class="btn btn-primary mt-2" data-page="repository">Manage Documents</button>
              </div>
            </div>
            
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">üìñ Document Viewer</h3>
              </div>
              <div class="card-body">
                <p class="text-muted">Read and navigate through your uploaded documents with full functionality.</p>
                <button class="btn btn-primary mt-2" data-page="viewer">View Documents</button>
              </div>
            </div>
            
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">üîç Search</h3>
              </div>
              <div class="card-body">
                <p class="text-muted">Search across all uploaded standards with advanced filtering.</p>
                <button class="btn btn-primary mt-2" data-page="search">Search Standards</button>
              </div>
            </div>
            
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">‚öñÔ∏è Compare</h3>
              </div>
              <div class="card-body">
                <p class="text-muted">Compare standards side-by-side and identify similarities and differences.</p>
                <button class="btn btn-primary mt-2" data-page="compare">Start Comparison</button>
              </div>
            </div>
            
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">üõ†Ô∏è Process Generator</h3>
              </div>
              <div class="card-body">
                <p class="text-muted">Generate custom WBS and process flows based on your project needs.</p>
                <button class="btn btn-primary mt-2" data-page="process">Generate Process</button>
              </div>
            </div>
            
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">üéØ Scenarios</h3>
              </div>
              <div class="card-body">
                <p class="text-muted">Explore tailored processes for different project scenarios.</p>
                <button class="btn btn-primary mt-2" data-page="scenarios">View Scenarios</button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Repository Page -->
        <div class="page" id="repository">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">üìÅ Standards Repository</h2>
            </div>
            <div class="card-body">
              <div class="form-group">
                <label class="form-label">Upload Standards Documents</label>
                <input type="file" id="fileInput" class="form-control" multiple accept=".pdf,.txt,.html,.htm,text/plain">
                <div class="text-muted mt-1">Supported formats: PDF, TXT, HTML</div>
              </div>
              
              <div class="mt-3">
                <h3 class="text-primary mb-2">Uploaded Documents</h3>
                <div id="fileList" class="search-results">
                  <div class="text-muted text-center py-4">No documents uploaded yet</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Document Viewer Page -->
        <div class="page" id="viewer">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">üìñ Document Viewer</h2>
            </div>
            <div class="card-body">
              <div class="viewer-controls">
                <div class="form-group" style="flex: 1; min-width: 200px;">
                  <select id="docSelect" class="form-control">
                    <option value="">-- Select a document --</option>
                  </select>
                </div>
                
                <div class="viewer-nav">
                  <button class="btn btn-outline" id="prevPage" title="Previous Page">‚Üê Prev</button>
                  <div class="page-indicator" id="currentPage">- / -</div>
                  <button class="btn btn-outline" id="nextPage" title="Next Page">Next ‚Üí</button>
                </div>
                
                <div class="d-flex gap-2">
                  <button class="btn btn-outline" id="bookmarkBtn" title="Bookmark this page">‚≠ê Bookmark</button>
                  <button class="btn btn-outline" id="copyDeepLink" title="Copy link to this view">üîó Copy Link</button>
                </div>
              </div>
              
              <div id="bookContent" class="viewer-container" style="height: 600px;">
                <div class="text-muted text-center py-4">
                  Select a document from the dropdown to start reading
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Search Page -->
        <div class="page" id="search">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">üîç Search Across Standards</h2>
            </div>
            <div class="card-body">
              <div class="form-group">
                <div class="d-flex gap-2">
                  <input type="text" id="searchBox" class="form-control" placeholder="Search for risk management, stakeholder analysis, etc.">
                  <button class="btn btn-primary" id="searchBtn">Search</button>
                </div>
              </div>
              
              <div class="mt-3">
                <h3 class="text-primary mb-2">Search Results</h3>
                <div id="searchResults" class="search-results">
                  <div class="text-muted text-center py-4">Enter a search term to find content across your standards</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Compare Page -->
        <div class="page" id="compare">
          <div class="grid grid-2">
            <div class="card">
              <div class="card-header">
                <h2 class="card-title">‚öñÔ∏è Document Comparison</h2>
              </div>
              <div class="card-body">
                <div class="form-group">
                  <label class="form-label">Select Content for Comparison</label>
                  <div class="d-flex gap-2">
                    <button class="btn btn-secondary" id="setA">Set as A</button>
                    <button class="btn btn-secondary" id="setB">Set as B</button>
                    <button class="btn btn-primary" id="compareBtn">Compare</button>
                  </div>
                  <div id="selectionPreview" class="mt-2 text-sm"></div>
                </div>
                
                <div class="comparison-container mt-3">
                  <div class="comparison-box" id="compareA">
                    <div class="text-muted">A ‚Äî Select content from a document or search result</div>
                  </div>
                  <div class="comparison-box" id="compareB">
                    <div class="text-muted">B ‚Äî Select content from a document or search result</div>
                  </div>
                </div>
                
                <div class="mt-2">
                  <button class="btn btn-outline" id="openCompareLink">Open Comparison Source</button>
                </div>
              </div>
            </div>
            
            <div class="card">
              <div class="card-header">
                <h2 class="card-title">üí° Insights</h2>
              </div>
              <div class="card-body">
                <div id="insightsPanel" class="viewer-container" style="height: 300px;">
                  <div class="text-muted">Compare documents A and B to see insights about similarities and differences</div>
                </div>
                <div class="d-flex gap-2 mt-2">
                  <button class="btn btn-primary" id="computeInsights">Compute Insights</button>
                  <button class="btn btn-secondary" id="exportInsights">Export Insights</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Process Generator Page -->
        <div class="page" id="process">
          <div class="grid grid-2">
            <div class="card">
              <div class="card-header">
                <h2 class="card-title">üõ†Ô∏è Process & WBS Generator</h2>
              </div>
              <div class="card-body">
                <div class="form-group">
                  <label class="form-label">Project Name</label>
                  <input type="text" id="projectName" class="form-control" placeholder="e.g., Mobile App Upgrade">
                </div>
                
                <div class="d-flex gap-2">
                  <button class="btn btn-primary" id="generateProcess">Generate Process</button>
                  <button class="btn btn-secondary" id="downloadProcess">Download Process</button>
                </div>
                
                <div class="mt-3">
                  <h3 class="text-primary mb-2">Process Output</h3>
                  <div id="processOutput" class="text-muted">
                    Generate a process to see the output here
                  </div>
                </div>
              </div>
            </div>
            
            <div class="card">
              <div class="card-header">
                <h2 class="card-title">ü™ú WBS Preview</h2>
              </div>
              <div class="card-body">
                <div id="wbsPreview" class="viewer-container">
                  <div class="text-muted">A WBS will be generated from your process</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Scenarios Page -->
        <div class="page" id="scenarios">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">üéØ Scenario-Based Process Tailoring</h2>
            </div>
            <div class="card-body">
              <div class="form-group">
                <label class="form-label">Select Project Scenario</label>
                <select id="scenarioSelect" class="form-control">
                  <option value="">Select a scenario</option>
                  <option value="software">Custom Software Development (Agile-lite)</option>
                  <option value="innovation">Innovative Product Development (R&D, Stage-Gate)</option>
                  <option value="government">Large Government Project (Predictive, High Governance)</option>
                </select>
              </div>
              
              <div class="d-flex gap-2 flex-wrap">
                <button class="btn btn-primary" id="generateScenarioProcess">Generate Tailored Process</button>
                <button class="btn btn-secondary" id="generateAllScenarios">Generate All 3</button>
                <button class="btn btn-secondary" id="downloadProcessDoc">Download Document</button>
                <button class="btn btn-secondary" id="exportDiagram">Export Diagram (SVG)</button>
              </div>
              
              <div class="mt-3">
                <h3 class="text-primary mb-2">Scenario Output</h3>
                <div id="scenarioOutput" class="text-muted">
                  Select a scenario and generate a process to see the output
                </div>
              </div>
              
              <div class="mt-3">
                <h3 class="text-primary mb-2">Scenario Details</h3>
                <div id="phase2Details" class="viewer-container">
                  <div class="text-muted">Generate a scenario to see process details, justification, and references</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Bookmarks Page -->
        <div class="page" id="bookmarks">
          <div class="card">
            <div class="card-header d-flex justify-between align-center">
              <h2 class="card-title">‚≠ê Bookmarks & Saved Views</h2>
              <div class="d-flex gap-2">
                <button class="btn btn-secondary" id="exportBookmarks">Export</button>
                <button class="btn btn-secondary" id="importBookmarks">Import</button>
                <button class="btn btn-outline" id="clearBookmarks">Clear All</button>
              </div>
            </div>
            <div class="card-body">
              <div id="bookmarksList" class="search-results">
                <div class="text-muted text-center py-4">No bookmarks saved yet</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Export Page -->
        <div class="page" id="export">
          <div class="grid grid-3">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">üìÑ Documents</h3>
              </div>
              <div class="card-body">
                <p class="text-muted mb-2">Export your process documents and WBS</p>
                <button class="btn btn-primary" id="downloadWBS2">Download WBS</button>
              </div>
            </div>
            
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">üìä Insights</h3>
              </div>
              <div class="card-body">
                <p class="text-muted mb-2">Export comparison insights and analysis</p>
                <button class="btn btn-primary" id="exportInsights2">Export Insights</button>
              </div>
            </div>
            
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">‚≠ê Bookmarks</h3>
              </div>
              <div class="card-body">
                <p class="text-muted mb-2">Export your saved bookmarks</p>
                <button class="btn btn-primary" id="exportBookmarks2">Export Bookmarks</button>
              </div>
            </div>
            
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">üõ†Ô∏è Processes</h3>
              </div>
              <div class="card-body">
                <p class="text-muted mb-2">Export generated processes</p>
                <button class="btn btn-primary" id="downloadProcess2">Download Process</button>
              </div>
            </div>
            
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">üéØ Scenarios</h3>
              </div>
              <div class="card-body">
                <p class="text-muted mb-2">Export scenario documents and diagrams</p>
                <button class="btn btn-primary" id="downloadProcessDoc2">Download Document</button>
                <button class="btn btn-primary mt-1" id="exportDiagram2">Export Diagram</button>
              </div>
            </div>
            
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">üìã README</h3>
              </div>
              <div class="card-body">
                <p class="text-muted mb-2">Export assignment README</p>
                <button class="btn btn-primary" id="exportReadme2">Export README</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // ========== Application State and Core Functionality ==========
    // All original functionality is preserved - only UI has been redesigned
    
    const state = {
      docs: {},
      index: null,
      selectedA: null,
      selectedB: null,
      bookmarksKey: 'pm_explorer_bookmarks_v1',
      scenarios: {},
      lastScenarioAction: 'none',
      currentDocId: null,
      currentPageIndex: 1
    };

    // Initialize search index
    function createIndex() {
      const idx = elasticlunr(function() {
        this.addField('title');
        this.addField('body');
        this.setRef('id');
      });
      state.index = idx;
    }
    createIndex();

    // PDF.js setup
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.worker.min.js';

    // Utility functions
    function uid(prefix='d') { return prefix + '_' + Math.random().toString(36).slice(2,9); }
    function escapeHtml(s) { if(!s) return ''; return s.replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
    function short(s, n=160){ if(!s) return ''; return s.length>n? s.slice(0,n-1)+'‚Ä¶': s; }

    // ========== Page Navigation ==========
    document.querySelectorAll('.nav-item[data-page]').forEach(item => {
      item.addEventListener('click', function(e) {
        e.preventDefault();
        const pageId = this.getAttribute('data-page');
        
        // Update active nav item
        document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
        this.classList.add('active');
        
        // Update page title
        const pageTitle = document.getElementById('currentPageTitle');
        pageTitle.textContent = this.querySelector('.nav-text').textContent;
        
        // Show selected page
        document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        
        // Special handling for viewer page
        if (pageId === 'viewer') {
          refreshDocSelect();
        }
      });
    });

    // Dashboard buttons navigation
    document.querySelectorAll('button[data-page]').forEach(button => {
      button.addEventListener('click', function() {
        const pageId = this.getAttribute('data-page');
        
        // Update active nav item
        document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
        document.querySelector(`.nav-item[data-page="${pageId}"]`).classList.add('active');
        
        // Update page title
        const pageTitle = document.getElementById('currentPageTitle');
        pageTitle.textContent = document.querySelector(`.nav-item[data-page="${pageId}"] .nav-text`).textContent;
        
        // Show selected page
        document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        
        // Special handling for viewer page
        if (pageId === 'viewer') {
          refreshDocSelect();
        }
      });
    });

    // ========== File Handling and Indexing ==========
    async function handleFiles(files) {
      for (const f of Array.from(files)) {
        const ext = f.name.split('.').pop().toLowerCase();
        const docId = uid(f.name.replace(/\W+/g,'_'));
        const doc = { id: docId, name: f.name, type: ext, pages: [], file: f };
        state.docs[docId] = doc;

        if (ext === 'pdf') {
          const arrayBuf = await f.arrayBuffer();
          const pdf = await pdfjsLib.getDocument({data: arrayBuf}).promise;
          for (let p=1;p<=pdf.numPages;p++){
            const page = await pdf.getPage(p);
            const txt = await page.getTextContent();
            const pageText = txt.items.map(i => i.str).join(' ');
            doc.pages.push({ page: p, text: pageText });
            state.index.addDoc({ id: `${docId}_p${p}`, title: `${f.name} ‚Äî page ${p}`, body: pageText, docId, page: p });
          }
        } else if (ext === 'txt' || ext === 'html' || ext === 'htm') {
          const text = await f.text();
          const chunks = chunkText(text, 800);
          chunks.forEach((c, i) => {
            const p = i+1;
            doc.pages.push({ page: p, text: c });
            state.index.addDoc({ id: `${docId}_p${p}`, title: `${f.name} ‚Äî page ${p}`, body: c, docId, page: p });
          });
        } else {
          const text = await f.text().catch(()=>'');
          doc.pages.push({ page: 1, text: text || `[Unable to extract text for ${f.name}]` });
          state.index.addDoc({ id: `${docId}_p1`, title: `${f.name} ‚Äî page 1`, body: doc.pages[0].text, docId, page: 1 });
        }
      }
      refreshDocList();
      refreshDocSelect();
      updateStats();
    }

    function chunkText(text, wordsPerChunk=800) {
      if (!text) return [''];
      const words = text.split(/\s+/);
      const out = [];
      for (let i=0;i<words.length;i+=wordsPerChunk) {
        out.push(words.slice(i,i+wordsPerChunk).join(' ').trim());
      }
      if(out.length===0) out.push(text);
      return out;
    }

    // ========== Document Viewer Functionality ==========
    function refreshDocSelect() {
      const select = document.getElementById('docSelect');
      select.innerHTML = '<option value="">-- Select a document --</option>';
      
      Object.keys(state.docs).forEach(id => {
        const d = state.docs[id];
        const opt = document.createElement('option');
        opt.value = id;
        opt.textContent = d.name;
        select.appendChild(opt);
      });
    }

    function openDoc(docId, page=1, highlightObj=null) {
      const doc = state.docs[docId];
      if(!doc) return;
      
      state.currentDocId = docId;
      state.currentPageIndex = Math.max(1, Math.min(page, doc.pages.length));
      
      document.getElementById('currentPage').textContent = `${state.currentPageIndex} / ${doc.pages.length}`;
      document.getElementById('docSelect').value = docId;
      
      renderPageContent(docId, state.currentPageIndex, highlightObj);
    }

    function renderPageContent(docId, pageNum, highlightObj=null) {
      const doc = state.docs[docId];
      if(!doc) return;
      
      const page = doc.pages.find(p=>p.page===pageNum);
      const el = document.getElementById('bookContent');
      
      if(!page) { 
        el.innerHTML = '<div class="text-muted text-center py-4">[page not found]</div>'; 
        return; 
      }
      
      let text = page.text || '[no text extracted]';
      
      if(highlightObj && highlightObj.q) {
        let start = typeof highlightObj.start === 'number' ? highlightObj.start : text.toLowerCase().indexOf(highlightObj.q.toLowerCase());
        if(start < 0) start = null;
        
        if(start !== null) {
          const end = typeof highlightObj.end === 'number' ? highlightObj.end : (start + highlightObj.q.length);
          const snipStart = Math.max(0, start - 300);
          const snipEnd = Math.min(text.length, end + 300);
          const snippet = text.slice(snipStart, snipEnd);
          const relStart = start - snipStart;
          const before = escapeHtml(snippet.slice(0, relStart));
          const mid = escapeHtml(snippet.slice(relStart, relStart + (end-start)));
          const after = escapeHtml(snippet.slice(relStart + (end-start)));
          
          el.innerHTML = before + `<mark>${mid}</mark>` + after;
          return;
        } else {
          const idx = text.toLowerCase().indexOf(highlightObj.q.toLowerCase());
          if(idx>=0){
            const start2 = Math.max(0, idx-80);
            const end2 = Math.min(text.length, idx + highlightObj.q.length + 80);
            const snippet = text.slice(start2, end2);
            const marked = snippet.replace(new RegExp(escapeRegExp(highlightObj.q),'i'), m=>`<mark>${escapeHtml(m)}</mark>`);
            el.innerHTML = marked;
            return;
          }
        }
      }
      
      el.textContent = text;
    }

    function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }

    // Document viewer event listeners
    document.getElementById('docSelect').addEventListener('change', (e) => {
      if(e.target.value) {
        openDoc(e.target.value, 1);
      }
    });

    document.getElementById('prevPage').addEventListener('click', () => {
      if(!state.currentDocId) return;
      openDoc(state.currentDocId, state.currentPageIndex - 1);
    });

    document.getElementById('nextPage').addEventListener('click', () => {
      if(!state.currentDocId) return;
      openDoc(state.currentDocId, state.currentPageIndex + 1);
    });

    // ========== UI Updates ==========
    function refreshDocList() {
      const fileList = document.getElementById('fileList');
      fileList.innerHTML = '';
      
      const keys = Object.keys(state.docs);
      if (keys.length === 0) {
        fileList.innerHTML = '<div class="text-muted text-center py-4">No documents uploaded yet</div>';
        return;
      }
      
      keys.forEach(id => {
        const d = state.docs[id];
        const div = document.createElement('div');
        div.className = 'result-item';
        div.innerHTML = `
          <div class="result-title">${escapeHtml(d.name)}</div>
          <div class="result-meta">${d.pages.length} pages ‚Ä¢ ${d.type.toUpperCase()}</div>
          <div class="d-flex gap-2 mt-2">
            <button class="btn btn-outline" data-doc="${id}" data-action="view">View</button>
            <button class="btn btn-outline" data-doc="${id}" data-action="setA">Set as A</button>
            <button class="btn btn-outline" data-doc="${id}" data-action="setB">Set as B</button>
          </div>
        `;
        fileList.appendChild(div);
      });

      // Add event listeners to buttons
      fileList.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', function() {
          const docId = this.getAttribute('data-doc');
          const action = this.getAttribute('data-action');
          
          if (action === 'setA') {
            setSelectionA({docId, pageNum: 1, excerpt: state.docs[docId].pages[0].text.slice(0, 300)});
          } else if (action === 'setB') {
            setSelectionB({docId, pageNum: 1, excerpt: state.docs[docId].pages[0].text.slice(0, 300)});
          } else if (action === 'view') {
            // Navigate to viewer page and open the document
            document.querySelector('.nav-item[data-page="viewer"]').click();
            openDoc(docId, 1);
          }
        });
      });
      
      updateStats();
    }

    function updateStats() {
      document.getElementById('docCount').textContent = Object.keys(state.docs).length;
      
      const bookmarks = loadBookmarks();
      document.getElementById('bookmarkCount').textContent = bookmarks.length;
    }

    // ========== Search Functionality ==========
    document.getElementById('searchBtn').addEventListener('click', doSearch);
    document.getElementById('searchBox').addEventListener('keydown', (e) => { 
      if(e.key === 'Enter') doSearch(); 
    });

    function doSearch(){
      const q = document.getElementById('searchBox').value.trim();
      const resDiv = document.getElementById('searchResults');
      resDiv.innerHTML = '';
      
      if(!q){ 
        resDiv.innerHTML = '<div class="text-muted text-center py-4">Enter a search term to find content across your standards</div>'; 
        return; 
      }

      let results = [];
      try {
        results = state.index.search(q, {
          fields: {
            title: { boost: 2 },
            body: { boost: 1 }
          },
          expand: true
        }).slice(0, 80);
      } catch(e){
        console.warn('elasticlunr search error', e);
        results = [];
      }

      if(!results || results.length === 0){
        const hits = [];
        const docs = state.index.documentStore.docs || {};
        for(const ref of Object.keys(docs)){
          const docRecord = state.index.documentStore.getDoc(ref);
          const body = (docRecord && docRecord.body) ? docRecord.body : '';
          if(body.toLowerCase().includes(q.toLowerCase())){
            hits.push({ ref, score: 0.1 });
          }
        }
        results = hits.slice(0,80);
      }

      if(!results || results.length === 0){
        resDiv.innerHTML = '<div class="text-muted text-center py-4">No results found</div>';
        return;
      }

      document.getElementById('searchCount').textContent = results.length;

      results.forEach(r => {
        const ref = r.ref;
        const docRecord = state.index.documentStore.getDoc(ref) || {};
        let docId = docRecord.docId;
        let pageNum = docRecord.page;
        
        if(!docId || !pageNum) {
          const m = ref.match(/^(.*)_p(\d+)$/);
          if(m) {
            docId = docId || m[1];
            pageNum = pageNum || parseInt(m[2], 10);
          } else {
            docId = docId || ref;
            pageNum = pageNum || 1;
          }
        }

        const doc = state.docs[docId];
        const page = doc ? doc.pages.find(p=>p.page===pageNum) : null;
        const text = page ? page.text : '';
        const snippet = findSnippet(text, q);
        
        const row = document.createElement('div');
        row.className = 'result-item';
        row.innerHTML = `
          <div class="result-title">${escapeHtml(doc ? doc.name : docId)}</div>
          <div class="result-meta">Page ${pageNum} ‚Ä¢ Score: ${r.score ? (typeof r.score === 'number' ? r.score.toFixed(2) : r.score) : '‚Äî'}</div>
          <div class="result-snippet">${escapeHtml(snippet)}</div>
          <div class="d-flex gap-2 mt-2">
            <button class="btn btn-outline" data-doc="${docId}" data-page="${pageNum}" data-q="${escapeHtml(q)}">View</button>
            <button class="btn btn-outline" data-doc="${docId}" data-page="${pageNum}" data-q="${escapeHtml(q)}" data-action="setA">Set as A</button>
            <button class="btn btn-outline" data-doc="${docId}" data-page="${pageNum}" data-q="${escapeHtml(q)}" data-action="setB">Set as B</button>
          </div>
        `;
        resDiv.appendChild(row);
      });

      // Add event listeners to result buttons
      resDiv.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', e => {
          const docId = e.target.getAttribute('data-doc');
          const pageNum = parseInt(e.target.getAttribute('data-page'), 10);
          const q = e.target.getAttribute('data-q');
          const action = e.target.getAttribute('data-action');
          
          if(action === 'setA') {
            setSelectionA({docId, pageNum, excerpt: q, q});
          } else if(action === 'setB') {
            setSelectionB({docId, pageNum, excerpt: q, q});
          } else {
            // Navigate to viewer and open the document with highlight
            document.querySelector('.nav-item[data-page="viewer"]').click();
            openDoc(docId, pageNum, {q});
          }
        });
      });
    }

    function findSnippet(text, q, n=100) {
      if (!text || !q) return short(text, n * 2);
      const qLower = q.toLowerCase();
      const tLower = text.toLowerCase();
      let index = tLower.indexOf(qLower);
      if (index === -1) return short(text, n * 2);
      const start = Math.max(0, index - n);
      const end = Math.min(text.length, index + q.length + n);
      let snippet = text.slice(start, end);
      if (start > 0) snippet = '... ' + snippet;
      if (end < text.length) snippet = snippet + ' ...';
      return snippet.replace(new RegExp(escapeRegExp(q),'gi'), m=>`[${m}]`);
    }

    // ========== Bookmarks Functionality ==========
    function loadBookmarks() { 
      return JSON.parse(localStorage.getItem(state.bookmarksKey) || '[]'); 
    }
    
    function saveBookmarks(arr) { 
      localStorage.setItem(state.bookmarksKey, JSON.stringify(arr)); 
    }
    
    function addBookmark(title, docId, page, excerpt, highlightRange) {
      const arr = loadBookmarks();
      const url = new URL(location.href);
      url.searchParams.set('doc', docId);
      url.searchParams.set('page', page);
      if(excerpt) url.searchParams.set('q', excerpt);
      if(highlightRange && typeof highlightRange.start === 'number') url.searchParams.set('start', highlightRange.start);
      if(highlightRange && typeof highlightRange.end === 'number') url.searchParams.set('end', highlightRange.end);
      
      arr.push({ 
        id: uid('bm'), 
        title, 
        docId, 
        page, 
        excerpt: short(excerpt, 80), 
        link: url.toString() 
      });
      
      saveBookmarks(arr);
      renderBookmarks();
      updateStats();
    }

    document.getElementById('bookmarkBtn').addEventListener('click', () => {
      if(!state.currentDocId) {
        alert('Open a document first.');
        return;
      }
      
      const pageText = state.docs[state.currentDocId].pages.find(p => p.page === state.currentPageIndex)?.text;
      if(!pageText) {
        alert('Could not find page content.');
        return;
      }
      
      let title = prompt('Enter a title for this bookmark (optional):');
      if(title === null) return;
      
      let selection = window.getSelection().toString().trim();
      let highlightRange = null;
      
      if(selection){
        let start = pageText.indexOf(selection);
        if(start>=0) highlightRange = {start, end: start+selection.length};
        if(!title) title = short(selection, 40);
      }
      
      addBookmark(
        title || state.docs[state.currentDocId].name, 
        state.currentDocId, 
        state.currentPageIndex, 
        selection || null, 
        highlightRange
      );
      
      alert('View bookmarked!');
    });

    document.getElementById('copyDeepLink').addEventListener('click', () => {
      if(!state.currentDocId) {
        alert('Open a document first.');
        return;
      }
      
      let q = null, start = null, end = null;
      const selection = window.getSelection().toString().trim();
      
      if(selection){
        const pageText = state.docs[state.currentDocId].pages.find(p => p.page === state.currentPageIndex)?.text;
        if(pageText){
          const idx = pageText.indexOf(selection);
          if(idx>=0){ 
            q = selection; 
            start = idx; 
            end = idx + selection.length; 
          }
        }
      }
      
      const url = new URL(location.href);
      url.searchParams.set('doc', state.currentDocId);
      url.searchParams.set('page', state.currentPageIndex);
      if(q) url.searchParams.set('q', q);
      if(typeof start === 'number') url.searchParams.set('start', start);
      if(typeof end === 'number') url.searchParams.set('end', end);
      
      navigator.clipboard.writeText(url.toString()).then(() => {
        alert('Deep link copied to clipboard.');
      });
    });

    function renderBookmarks() {
      const list = loadBookmarks();
      const el = document.getElementById('bookmarksList');
      el.innerHTML = '';
      
      if(list.length === 0){ 
        el.innerHTML = '<div class="text-muted text-center py-4">No bookmarks saved yet</div>'; 
        return; 
      }
      
      list.forEach(b => {
        const d = state.docs[b.docId] ? state.docs[b.docId].name : b.docId;
        const row = document.createElement('div');
        row.className = 'result-item';
        row.innerHTML = `
          <div class="result-title">${escapeHtml(b.title || d)}</div>
          <div class="result-meta">${d} ‚Ä¢ page ${b.page}</div>
          <div class="d-flex gap-2 mt-2">
            <button class="btn btn-outline" data-link="${b.link}">Open</button>
            <button class="btn btn-outline" data-id="${b.id}">Delete</button>
          </div>
        `;
        
        row.querySelectorAll('button')[0].onclick = () => {
          const url = new URL(b.link, location.href);
          const doc = url.searchParams.get('doc') || url.hash.split('&').find(s => s.startsWith('doc='))?.split('=')[1];
          const page = parseInt(url.searchParams.get('page') || 1);
          const q = url.searchParams.get('q') || (url.hash.startsWith('#q=') ? decodeURIComponent(url.hash.slice(3)) : null);
          const start = url.searchParams.get('start') ? parseInt(url.searchParams.get('start')) : undefined;
          const end = url.searchParams.get('end') ? parseInt(url.searchParams.get('end')) : undefined;

          if(doc) {
            document.querySelector('.nav-item[data-page="viewer"]').click();
            openDoc(doc, page, q ? {q, start, end} : null);
          }
        };
        
        row.querySelectorAll('button')[1].onclick = () => {
          const arr = loadBookmarks().filter(x => x.id !== b.id);
          saveBookmarks(arr);
          renderBookmarks();
          updateStats();
        };
        
        el.appendChild(row);
      });
    }

    document.getElementById('clearBookmarks').addEventListener('click', () => { 
      if(confirm('Clear all bookmarks?')) { 
        saveBookmarks([]); 
        renderBookmarks(); 
        updateStats();
      } 
    });

    document.getElementById('exportBookmarks').addEventListener('click', () => { 
      const data = JSON.stringify(loadBookmarks(), null, 2); 
      downloadData('pm_bookmarks.json', data, 'application/json'); 
    });

    document.getElementById('importBookmarks').addEventListener('click', () => {
      const inp = document.createElement('input'); 
      inp.type = 'file'; 
      inp.accept = 'application/json';
      inp.onchange = async () => {
        const f = inp.files[0]; 
        if(!f) return;
        const text = await f.text();
        try { 
          const arr = JSON.parse(text); 
          saveBookmarks(arr); 
          renderBookmarks(); 
          updateStats();
          alert('Imported bookmarks.'); 
        }
        catch(e){ alert('Invalid JSON'); }
      }; 
      inp.click();
    });

    // ========== Comparison Functionality ==========
    function setSelectionA(sel) {
      state.selectedA = sel;
      document.getElementById('compareA').innerHTML = `
        <div class="text-primary"><strong>A:</strong> ${state.docs[sel.docId]?.name || sel.docId} ‚Ä¢ page ${sel.pageNum}</div>
        <div class="mt-2">${short(sel.excerpt,300)}</div>
      `;
      updateSelectionPreview();
    }

    function setSelectionB(sel) {
      state.selectedB = sel;
      document.getElementById('compareB').innerHTML = `
        <div class="text-primary"><strong>B:</strong> ${state.docs[sel.docId]?.name || sel.docId} ‚Ä¢ page ${sel.pageNum}</div>
        <div class="mt-2">${short(sel.excerpt,300)}</div>
      `;
      updateSelectionPreview();
    }

    function updateSelectionPreview() {
      const p = document.getElementById('selectionPreview');
      p.innerHTML = `
        <div><strong>A</strong>: ${state.selectedA ? (state.docs[state.selectedA.docId]?.name + ' page ' + state.selectedA.pageNum) : '‚Äî'}</div>
        <div><strong>B</strong>: ${state.selectedB ? (state.docs[state.selectedB.docId]?.name + ' page ' + state.selectedB.pageNum) : '‚Äî'}</div>
      `;
    }

    document.getElementById('setA').addEventListener('click', () => {
      if(!state.currentDocId) {
        alert('Open a document in the viewer to set as A.');
        return;
      }
      
      const page = state.docs[state.currentDocId].pages.find(p => p.page === state.currentPageIndex);
      const excerpt = page?.text?.slice(0,300) || '';
      const selectionText = window.getSelection().toString().trim();
      
      if (selectionText) {
        const startIdx = page?.text?.indexOf(selectionText) || -1;
        if (startIdx >= 0) {
          return setSelectionA({
            docId: state.currentDocId, 
            pageNum: state.currentPageIndex, 
            excerpt: selectionText, 
            q: selectionText.split(' ').slice(0,6).join(' ')
          });
        }
      }
      
      setSelectionA({
        docId: state.currentDocId, 
        pageNum: state.currentPageIndex, 
        excerpt, 
        q: excerpt.split(' ').slice(0,6).join(' ')
      });
    });

    document.getElementById('setB').addEventListener('click', () => {
      if(!state.currentDocId) {
        alert('Open a document in the viewer to set as B.');
        return;
      }
      
      const page = state.docs[state.currentDocId].pages.find(p => p.page === state.currentPageIndex);
      const excerpt = page?.text?.slice(0,300) || '';
      const selectionText = window.getSelection().toString().trim();
      
      if (selectionText) {
        const startIdx = page?.text?.indexOf(selectionText) || -1;
        if (startIdx >= 0) {
          return setSelectionB({
            docId: state.currentDocId, 
            pageNum: state.currentPageIndex, 
            excerpt: selectionText, 
            q: selectionText.split(' ').slice(0,6).join(' ')
          });
        }
      }
      
      setSelectionB({
        docId: state.currentDocId, 
        pageNum: state.currentPageIndex, 
        excerpt, 
        q: excerpt.split(' ').slice(0,6).join(' ')
      });
    });

    document.getElementById('compareBtn').addEventListener('click', () => {
      if(!state.selectedA || !state.selectedB) {
        alert('Please set both A and B before comparing');
        return;
      }
      doCompare();
    });

    document.getElementById('openCompareLink').addEventListener('click', () => {
      if(state.selectedA){
        const A = state.selectedA;
        document.querySelector('.nav-item[data-page="viewer"]').click();
        openDoc(A.docId, A.pageNum, {q: A.q});
      } else {
        alert('Select A first.');
      }
    });

    function doCompare(){
      const A = state.selectedA, B = state.selectedB;
      if(!A || !B) return;
      
      const textA = state.docs[A.docId].pages.find(p => p.page === A.pageNum).text || '';
      const textB = state.docs[B.docId].pages.find(p => p.page === B.pageNum).text || '';
      const common = findCommonPhrases(textA, textB, 4);

      const aEl = document.getElementById('compareA');
      const bEl = document.getElementById('compareB');

      const Aname = state.docs[A.docId].name;
      const Bname = state.docs[B.docId].name;
      
      aEl.innerHTML = `<div class="text-primary"><strong>A: ${Aname} ‚Äî page ${A.pageNum}</strong></div><div class="mt-2">${highlightMany(textA, common, 'red')}</div>`;
      bEl.innerHTML = `<div class="text-primary"><strong>B: ${Bname} ‚Äî page ${B.pageNum}</strong></div><div class="mt-2">${highlightMany(textB, common, 'red')}</div>`;

      // Insights based on comparison
      const [diffA, diffB] = findUniquePhrases(textA, textB, 6);
      const similarities = common.slice(0,6);
      const uniqueA = diffA.slice(0,6);
      const uniqueB = diffB.slice(0,6);
      const out = document.getElementById('insightsPanel');

      // Add Top Unique Terms for richer insight
      const topUniqueA = topUniqueTerms(textA, textB, 5);
      const topUniqueB = topUniqueTerms(textB, textA, 5);

      out.innerHTML = `
        <div class="mb-3"><strong>Similarity Summary (Common phrases)</strong>
          <div class="mt-1">${similarities.length ? similarities.map(s => `‚Ä¢ ${escapeHtml(short(s,80))}`).join('<br>') : 'No large exact-phrase overlaps detected; consider adjusting search terms.'}</div>
        </div>
        <div class="mb-3"><strong>Unique Focus in ${escapeHtml(Aname)}</strong>
          <div class="mt-1">
            ${uniqueA.map(s => `‚Ä¢ ${escapeHtml(short(s,80))}`).join('<br>')}
            <div class="mt-2"><em>Top Unique Terms:</em> ${topUniqueA.length ? topUniqueA.join(', ') : '‚Äî'}</div>
          </div>
        </div>
        <div><strong>Unique Focus in ${escapeHtml(Bname)}</strong>
          <div class="mt-1">
            ${uniqueB.map(s => `‚Ä¢ ${escapeHtml(short(s,80))}`).join('<br>')}
            <div class="mt-2"><em>Top Unique Terms:</em> ${topUniqueB.length ? topUniqueB.join(', ') : '‚Äî'}</div>
          </div>
        </div>
      `;
    }

    function findCommonPhrases(text1, text2, minLength=4) {
      const common = new Set();
      const words1 = text1.toLowerCase().replace(/[^a-z0-9\s]/g,' ').split(/\s+/).filter(w=>w.length>0);
      const words2 = text2.toLowerCase().replace(/[^a-z0-9\s]/g,' ').split(/\s+/).filter(w=>w.length>0);
      
      for(let len = 6; len >= minLength; len--){
        const phrases1 = new Set();
        for(let i=0; i<=words1.length-len; i++){ 
          phrases1.add(words1.slice(i, i+len).join(' ')); 
        }
        
        for(let i=0; i<=words2.length-len; i++){
          const phrase = words2.slice(i, i+len).join(' ');
          if(phrases1.has(phrase) && !Array.from(common).some(c=>c.includes(phrase))){
            common.add(phrase);
          }
        }
      }
      
      return Array.from(common);
    }

    function highlightMany(text, phrases, color='mark') {
      let html = escapeHtml(text);
      phrases.sort((a,b) => b.length - a.length);
      
      phrases.forEach(p => {
        const escapedP = escapeRegExp(escapeHtml(p));
        html = html.replace(new RegExp(escapedP, 'gi'), m => `<mark>${m}</mark>`);
      });
      
      return html;
    }

    function findUniquePhrases(text1, text2, len=6) {
      const words1 = text1.toLowerCase().replace(/[^a-z0-9\s]/g,' ').split(/\s+/).filter(w=>w.length>0);
      const words2 = text2.toLowerCase().replace(/[^a-z0-9\s]/g,' ').split(/\s+/).filter(w=>w.length>0);
      
      const phrases2 = new Set();
      for(let i=0; i<=words2.length-len; i++){ 
        phrases2.add(words2.slice(i, i+len).join(' ')); 
      }
      
      const unique1 = new Set();
      for(let i=0; i<=words1.length-len; i++){
        const phrase = words1.slice(i, i+len).join(' ');
        if(!phrases2.has(phrase) && !Array.from(unique1).some(u=>u.includes(phrase))){
          unique1.add(phrase);
        }
      }

      const phrases1 = new Set();
      for(let i=0; i<=words1.length-len; i++){ 
        phrases1.add(words1.slice(i, i+len).join(' ')); 
      }
      
      const unique2 = new Set();
      for(let i=0; i<=words2.length-len; i++){
        const phrase = words2.slice(i, i+len).join(' ');
        if(!phrases1.has(phrase) && !Array.from(unique2).some(u=>u.includes(phrase))){
          unique2.add(phrase);
        }
      }

      return [Array.from(unique1), Array.from(unique2)];
    }

    function topUniqueTerms(text, otherText, n=8){
      const t = text.toLowerCase().replace(/[^a-z0-9\s]/g,' ').split(/\s+/).filter(w=>w.length>3);
      const o = new Set((otherText||'').toLowerCase().split(/\s+/));
      const freq = {};
      
      t.forEach(w => { 
        if(!o.has(w)) freq[w] = (freq[w]||0) + 1; 
      });
      
      const arr = Object.entries(freq).sort((a,b) => b[1]-a[1]).map(x=>x[0]);
      return arr.slice(0,n);
    }

    document.getElementById('computeInsights').addEventListener('click', () => {
      if(state.selectedA && state.selectedB) { 
        doCompare(); 
        return; 
      }
      
      const docKeys = Object.keys(state.docs);
      if(docKeys.length < 2) {
        alert('Upload at least two standards to compute insights.');
        return;
      }
      
      const d0 = state.docs[docKeys[0]];
      const d1 = state.docs[docKeys[1]];
      const t0 = d0.pages.map(p=>p.text).join(' ');
      const t1 = d1.pages.map(p=>p.text).join(' ');
      const common = findCommonPhrases(t0,t1,4).slice(0,15);
      const out = document.getElementById('insightsPanel');

      const [diffA, diffB] = findUniquePhrases(t0, t1, 6);
      const topUniqueA = topUniqueTerms(t0, t1, 5);
      const topUniqueB = topUniqueTerms(t1, t0, 5);

      out.innerHTML = `
        <div class="mb-3"><strong>Repo-level similarities between ${escapeHtml(d0.name)} and ${escapeHtml(d1.name)}</strong>
          <div class="mt-1">${common.length ? common.map(s => `‚Ä¢ ${escapeHtml(short(s,110))}`).join('<br>') : 'No long-phrase similarities found.'}</div>
        </div>
        <div class="mb-3"><strong>Unique Focus (Phrases) in ${escapeHtml(d0.name)}</strong>
          <div class="mt-1">${diffA.slice(0,4).map(s => `‚Ä¢ ${escapeHtml(short(s,80))}`).join('<br>')}</div>
          <div class="mt-2"><em>Top Unique Terms:</em> ${topUniqueA.length ? topUniqueA.join(', ') : '‚Äî'}</div>
        </div>
        <div><strong>Unique Focus (Phrases) in ${escapeHtml(d1.name)}</strong>
          <div class="mt-1">${diffB.slice(0,4).map(s => `‚Ä¢ ${escapeHtml(short(s,80))}`).join('<br>')}</div>
          <div class="mt-2"><em>Top Unique Terms:</em> ${topUniqueB.length ? topUniqueB.join(', ') : '‚Äî'}</div>
        </div>
      `;
    });

    // ========== Process Generator ==========
    document.getElementById('generateProcess').addEventListener('click', generateProcess);

    function generateProcess(){
      const projectName = (document.getElementById('projectName').value || 'Project').trim();
      let seeds = [];
      
      if(state.selectedA) seeds.push(state.docs[state.selectedA.docId].pages.find(p=>p.page===state.selectedA.pageNum).text || '');
      if(state.selectedB) seeds.push(state.docs[state.selectedB.docId].pages.find(p=>p.page===state.selectedB.pageNum).text || '');
      
      if(seeds.length === 0 && Object.keys(state.docs).length > 0){
        const doc = state.docs[Object.keys(state.docs)[0]];
        seeds.push(doc.pages.map(p=>p.text).join(' '));
      }
      
      let keywords = [];
      seeds.forEach(s => keywords.push(...topUniqueTerms(s, '', 10)));
      keywords = [...new Set(keywords.filter(w=>w.length>4))].slice(0,8);

      let phases = ['Initiation','Planning','Execution','Monitoring & Control','Closing'];
      if(keywords.some(k=>k.includes('sprint')||k.includes('agile'))) phases = ['Initiation','Iteration Planning','Execution & Build','Review & Retrospective','Closing'];
      if(keywords.some(k=>k.includes('stage')||k.includes('gate'))) phases = ['Concept','Definition','Development','Transition','Closure'];

      const wbs = buildWBS(projectName, phases);
      document.getElementById('wbsPreview').innerHTML = `<pre>${wbsToMarkdown(projectName, wbs)}</pre>`;
      document.getElementById('processOutput').innerHTML = `<div>Generated WBS for <strong>${escapeHtml(projectName)}</strong> using a ${phases.length > 5 ? 'Stage-Gate' : 'Sequential'} approach (keywords: ${keywords.join(', ')}).</div>`;
    }

    function buildWBS(projectName, phases) {
      const activitiesMap = {
        'Initiation': ['Develop Charter','Identify Stakeholders','Define High-level Scope'],
        'Planning': ['Develop Schedule','Estimate Costs','Define Scope/WBS','Plan Risk Management','Plan Quality'],
        'Execution': ['Direct & Manage Project Work','Manage Stakeholder Engagement','Acquire Resources','Implement Risk Responses'],
        'Monitoring & Control': ['Monitor Progress','Perform Integrated Change Control','Manage Risks','Validate Scope'],
        'Closing': ['Obtain Final Acceptance','Close Contracts','Conduct Lessons Learned','Archive Project Documents'],
        'Iteration Planning': ['Refine Backlog','Plan Sprint/Iteration','Define Acceptance Criteria'],
        'Execution & Build': ['Design, Build, Test Iteration','Conduct Daily Stand-ups','Continuous Integration'],
        'Review & Retrospective': ['Demo to Stakeholders','Conduct Retrospective','Adjust Backlog'],
        'Concept': ['Business Case Approval','High-level Requirements','Feasibility Study'],
        'Definition': ['Detailed Requirements','Design Architecture','Develop PMP'],
        'Development': ['Execute Build/Test','Manage Suppliers','Quality Assurance'],
        'Transition': ['User Acceptance Testing','Training & Handover','Launch'],
        'Closure': ['Final Audit','Closeout Report','Benefit Realization Review']
      };

      return {
        projectName,
        phases: phases.map(p => ({
          name: p,
          activities: activitiesMap[p] || activitiesMap['Initiation'] // fallback to initiation activities
        }))
      };
    }

    function wbsToMarkdown(projectName, wbs) {
      let out = `# WBS ‚Äî ${projectName}\n\n`;
      out += `Generated: ${new Date().toISOString()}\n\n`;
      
      wbs.phases.forEach((p,i) => {
        out += `## ${i+1}. ${p.name}\n`;
        p.activities.forEach((a,j) => {
          out += `- ${i+1}.${j+1} ${a}\n`;
        });
        out += '\n';
      });
      
      out += `\n---\n_This WBS was produced by the PM Standards Explorer prototype. Tailor activities as required for your project._\n`;
      return out;
    }

    // ========== Scenarios ==========
    const SCENARIO_TEMPLATES = {
      software: {
        title: 'Custom Software Development Project',
        key: 'software',
        context: 'Well-defined requirements, <6 months, <7 team members. Emphasize speed and flexibility.',
        processType: 'Lightweight iterative (Agile-inspired)',
        phases: [
          { name: 'Initiation', activities: ['Define project vision & objectives','Identify stakeholders','High-level requirements'], roles: ['Project Sponsor','Product Owner'], artifacts: ['Project Charter','Stakeholder Register'], gates: ['Go/No-Go to planning'], refs: ['PMBOK ¬ß2.2','PMBOK ¬ß4.3','PRINCE2 Ch 2'] },
          { name: 'Planning', activities: ['Refine backlog','Release plan (sprints)','Define acceptance criteria','Technical spike (if needed)'], roles: ['Scrum Master/Tech Lead','Product Owner'], artifacts: ['Product Backlog','Sprint Plan','Risk Log'], gates: ['Sprint 0 readiness'], refs: ['PMBOK ¬ß6','ISO 21502 ¬ß5.4'] },
          { name: 'Execution (Iterative Delivery)', activities: ['Sprint cycles: design, build, test','Continuous integration','Demo to stakeholders'], roles: ['Development Team','QA'], artifacts: ['Increment','Test Reports','CI Build'], gates: ['Release candidate review'], refs: ['PMBOK ¬ß8','PRINCE2 Ch 6'] },
          { name: 'Monitoring & Control', activities: ['Daily stand-ups','Burndown & metrics','Risk reviews','Change control lightweight'], roles: ['Project Manager / Scrum Master'], artifacts: ['Status Dashboard','Risk Register'], gates: ['Acceptance for release'], refs: ['PMBOK ¬ß4.4','ISO 21502 ¬ß6.3'] },
          { name: 'Closing', activities: ['Acceptance','Handover','Retrospective','Document lessons learned'], roles: ['Project Manager','Product Owner'], artifacts: ['Acceptance Certificate','Lessons Learned'], gates: ['Formal closeout'], refs: ['PMBOK ¬ß11','PRINCE2 Ch 7'] }
        ],
        tailoringRationale: 'Skip heavy governance, emphasize short iterations, automate CI/CD, and keep documentation lean. Use lightweight change control and adopt frequent demos to validate requirements early.'
      },
      innovation: {
        title: 'Innovative Product Development Project',
        key: 'innovation',
        context: 'R&D-heavy, uncertain outcomes, ~1 year duration. Emphasize discovery, stage-gates, and IP management.',
        processType: 'Hybrid (Iterative Discovery + Stage-Gate Governance)',
        phases: [
          { name: 'Concept & Business Case', activities: ['Define problem space','Market/Competitor analysis','Feasibility study','Stage-gate 1: Approval to Invest'], roles: ['Innovation Lead','Product Manager'], artifacts: ['Business Case','Problem Statement'], gates: ['Concept Approval (Stage Gate 1)'], refs: ['PMBOK ¬ß2','PRINCE2 Ch 2'] },
          { name: 'Discovery & Experimentation', activities: ['Build prototypes (MVP)','Customer feedback cycles','Iterative refinement','Define core IP'], roles: ['R&D Team','UX/Design'], artifacts: ['Prototypes','Experiment Reports','IP Register'], gates: ['Validated solution'], refs: ['ISO 21502 ¬ß5.5'] },
          { name: 'Develop & Stabilize', activities: ['Refine product','Scale architecture','Regulatory checks','Quality assurance'], roles: ['Engineering Manager','QA','Compliance'], artifacts: ['Release Plan','QA Reports','Compliance Checklist'], gates: ['Readiness to scale'], refs: ['ISO 21500 ¬ß6','PMBOK ¬ß10'] },
          { name: 'Monitoring & Governance', activities: ['Portfolio oversight','Benefit tracking','Risk & IP management'], roles: ['Program Manager','IP Counsel'], artifacts: ['Benefit Register','Risk Log','IP Register'], gates: ['Business case review'], refs: ['PMBOK ¬ß4','PRINCE2 Ch 5'] },
          { name: 'Transition & Closure', activities: ['Commercialization plan','Knowledge transfer','Post-launch evaluation'], roles: ['Product Manager','Sales'], artifacts: ['Go-to-market Plan','Lessons Learned'], gates: ['Commercial launch decision'], refs: ['PMBOK ¬ß11','ISO 21502 ¬ß7'] }
        ],
        tailoringRationale: 'Combine stage-gate decision points for investment control with iterative discovery cycles. Emphasize experiments, define clear pivot criteria, and include IP/regulatory checks early.'
      },
      government: {
        title: 'Large Government Project',
        key: 'government',
        context: 'Civil, electrical, and IT components, 2-year duration. Emphasize governance, compliance, procurement, and stakeholder reporting.',
        processType: 'Predictive / Stage-based (PRINCE2-style) with strong governance',
        phases: [
          { name: 'Project Initiation & Governance', activities: ['Establish governance structure','Detailed business case','Stakeholder & regulatory mapping'], roles: ['Program Sponsor','Steering Committee','Project Director'], artifacts: ['Business Case','Governance Plan','Stakeholder Register'], gates: ['Authority to proceed / Funding approval'], refs: ['PRINCE2 Ch 2','PMBOK ¬ß2','ISO 21500 ¬ß5'] },
          { name: 'Detailed Design & Procurement', activities: ['Detailed engineering design','Procurement planning & tendering','Contract packaging'], roles: ['Design Leads','Procurement','Legal'], artifacts: ['Tender Documents','Design Packages','Procurement Contracts'], gates: ['Procurement award / design sign-off'], refs: ['ISO 21502 ¬ß6','PRINCE2 Ch 7'] },
          { name: 'Construction & Integration', activities: ['Civil works','Electrical installation','Systems integration','Factory acceptance tests'], roles: ['Construction Manager','Systems Integrator','QA'], artifacts: ['Installation Reports','Test Certificates','Integration Plan'], gates: ['Stage acceptance / handover to integration'], refs: ['PMBOK ¬ß8','ISO 21500 ¬ß6'] },
          { name: 'Commissioning & Acceptance', activities: ['System commissioning','Compliance verification','User training and transition'], roles: ['Commissioning Lead','Compliance Officer','Training Lead'], artifacts: ['Commissioning Reports','Training Materials','Acceptance Certificates'], gates: ['Operational acceptance'], refs: ['PRINCE2 Ch 6','PMBOK ¬ß11'] },
          { name: 'Operations Handover & Closeout', activities: ['Handover to operations','Close contracts','Post-implementation review'], roles: ['Operations Manager','Contract Manager'], artifacts: ['Handover Pack','Final Accounts','Lessons Learned'], gates: ['Final sign-off & audit'], refs: ['PMBOK ¬ß11','ISO 21500 ¬ß7'] }
        ],
        tailoringRationale: 'A predictive approach is required due to the scale and compliance needs. Strong, centralized governance (Steering Committee) is critical. Tailoring focuses on separating design/procurement from execution stages and adding explicit gates for compliance/audit sign-off.'
      }
    };

    document.getElementById('generateScenarioProcess').addEventListener('click', () => {
      const key = document.getElementById('scenarioSelect').value;
      if(!key) {
        alert('Select a scenario first.');
        return;
      }
      
      const template = SCENARIO_TEMPLATES[key];
      state.scenarios[key] = JSON.parse(JSON.stringify(template));
      renderScenarioToUI(key, template);
      document.getElementById('scenarioOutput').innerHTML = `<div>Generated: <strong>${escapeHtml(template.title)}</strong></div>`;
      state.lastScenarioAction = 'single';
    });

    document.getElementById('generateAllScenarios').addEventListener('click', () => {
      for (const k of Object.keys(SCENARIO_TEMPLATES)) {
        state.scenarios[k] = JSON.parse(JSON.stringify(SCENARIO_TEMPLATES[k]));
      }

      const firstKey = Object.keys(SCENARIO_TEMPLATES)[0];
      document.getElementById('scenarioSelect').value = firstKey;

      renderAllScenariosToUI();

      document.getElementById('scenarioOutput').innerHTML =
        `<div>Generated all 3 scenarios: <strong>Custom Software</strong>, <strong>Innovative Product</strong>, <strong>Large Government</strong>. Showing combined view below.</div>`;

      state.lastScenarioAction = 'all';
      generateAndDownloadCombinedScenarios();
    });

    function renderAllScenariosToUI() {
      const container = document.getElementById('phase2Details');
      const html = [];
      
      html.push(`<h3 class="text-primary mb-3">All Project Scenarios - Combined View</h3>`);
      
      Object.keys(SCENARIO_TEMPLATES).forEach((key, index) => {
        const template = SCENARIO_TEMPLATES[key];
        
        html.push(`<div class="scenario-section ${index > 0 ? 'mt-4' : ''}" style="border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; background: var(--bg-surface);">`);
        
        html.push(`<h4 style="color: var(--primary-light); margin-bottom: 12px;">${index + 1}. ${escapeHtml(template.title)}</h4>`);
        html.push(`<div><strong>Context:</strong> ${escapeHtml(template.context)}</div>`);
        html.push(`<div class="mt-2"><span class="tag" style="background:rgba(67,97,238,0.1); padding:4px 8px; border-radius:4px;">${escapeHtml(template.processType)}</span></div>`);

        html.push(`<h5 class="mt-3 text-primary">Phases & Activities</h5>`);
        html.push('<table style="width:100%; border-collapse:collapse; font-size: 13px;"><thead><tr style="border-bottom:1px solid var(--border);"><th style="padding:8px; text-align:left;">Phase</th><th style="padding:8px; text-align:left;">Key Activities</th><th style="padding:8px; text-align:left;">Roles</th><th style="padding:8px; text-align:left;">Artifacts</th></tr></thead><tbody>');
        
        template.phases.forEach((p, i) => {
          html.push(`<tr style="border-bottom:1px solid var(--border);">
            <td style="padding:8px; vertical-align:top;"><strong>${i+1}. ${escapeHtml(p.name)}</strong></td>
            <td style="padding:8px; vertical-align:top;">${escapeHtml(p.activities.join('; '))}</td>
            <td style="padding:8px; vertical-align:top;">${escapeHtml((p.roles||[]).join(', '))}</td>
            <td style="padding:8px; vertical-align:top;">${escapeHtml((p.artifacts||[]).join('; '))}</td>
          </tr>`);
        });
        
        html.push('</tbody></table>');

        html.push(`<h5 class="mt-3 text-primary">Tailoring Justification</h5>`);
        html.push(`<div style="font-size: 14px; line-height: 1.5;">${escapeHtml(template.tailoringRationale)}</div>`);

        const refs = buildReferenceList(template);
        html.push(`<h5 class="mt-3 text-primary">Referenced Standards</h5>`);
        html.push(`<div>${refs.length ? refs.map(r => `<span class="tag" style="background:rgba(108,87,245,0.15); font-weight:400; font-size:12px; margin-right: 6px; margin-bottom: 4px; display: inline-block;">${escapeHtml(r)}</span>`).join('') : '‚Äî'}</div>`);

        html.push(`</div>`);
      });

      container.innerHTML = html.join('');
    }

    function generateAndDownloadCombinedScenarios() {
      let combinedMd = `# All Three Project Management Scenarios\n\n`;
      combinedMd += `Generated: ${new Date().toISOString().split('T')[0]}\n\n`;
      combinedMd += `This document contains tailored project management processes for three different project scenarios:\n\n`;

      Object.keys(SCENARIO_TEMPLATES).forEach((key, index) => {
        const template = SCENARIO_TEMPLATES[key];
        
        combinedMd += `## ${index + 1}. ${template.title}\n\n`;
        combinedMd += `### Context & Rationale\n\n`;
        combinedMd += `**Process Type:** ${template.processType}\n\n`;
        combinedMd += `**Project Context:** ${template.context}\n\n`;
        combinedMd += `**Tailoring Justification:** ${template.tailoringRationale}\n\n`;

        combinedMd += `### Process Phases & Details\n\n`;
        template.phases.forEach((p, i) => {
          combinedMd += `#### ${i+1}. ${p.name}\n`;
          combinedMd += `- **Key Activities:** ${p.activities.join('; ')}\n`;
          combinedMd += `- **Roles:** ${(p.roles || []).join(', ')}\n`;
          combinedMd += `- **Artifacts/Deliverables:** ${(p.artifacts || []).join('; ')}\n`;
          combinedMd += `- **Decision Gates:** ${(p.gates || []).join('; ')}\n`;
          combinedMd += `- **References:** ${(p.refs || []).join(', ')}\n\n`;
        });

        combinedMd += `### Referenced Standards\n\n`;
        const refs = buildReferenceList(template);
        if(refs.length){
          refs.forEach(r => { combinedMd += `- ${r}\n`; });
        } else {
          combinedMd += `(No specific standards referenced in this template)\n`;
        }

        combinedMd += `\n---\n\n`;
      });

      combinedMd += `_This combined scenarios document was produced by the PM Standards Explorer prototype. Tailor processes as required for your specific project needs._\n`;

      downloadData('All_Project_Scenarios.md', combinedMd, 'text/markdown;charset=utf-8');
    }

    // ========== Export Functionality ==========
    function downloadData(filename, content, mime='text/plain'){
      const blob = new Blob([content], {type: mime});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(() => { 
        URL.revokeObjectURL(url); 
        a.remove(); 
      }, 5000);
    }

    document.getElementById('downloadWBS').addEventListener('click', () => {
      let md = document.getElementById('wbsPreview').textContent;
      if(!md || md.includes('A WBS will be generated')) {
        const defaultWBS = buildWBS('Sample Project', ['Initiation','Planning','Execution','Monitoring & Control','Closing']);
        md = wbsToMarkdown('Sample Project', defaultWBS);
      }
      downloadData('Assignment1_WBS.md', md, 'text/markdown');
    });

    document.getElementById('exportInsights').addEventListener('click', () => {
      const content = document.getElementById('insightsPanel').innerText;
      downloadData('PM_Insights.txt', content, 'text/plain');
    });

    document.getElementById('downloadProcess').addEventListener('click', () => {
      const md = document.getElementById('wbsPreview').textContent || 'WBS not generated yet.';
      downloadData('WBS.md', md, 'text/markdown');
    });

    document.getElementById('downloadProcessDoc').addEventListener('click', () => {
      const key = document.getElementById('scenarioSelect').value;
      if(!key && Object.keys(state.scenarios).length === 0) {
        alert('Please generate a process first.');
        return;
      }
      
      const template = key ? state.scenarios[key] : Object.values(state.scenarios)[0];
      if (!template) {
        alert('No scenario selected or generated.');
        return;
      }

      const md = processTemplateToMarkdown(template);
      downloadData(`${template.title.replace(/\W+/g,'_')}_ProcessDesign.md`, md, 'text/markdown;charset=utf-8');
    });

    document.getElementById('exportDiagram').addEventListener('click', () => {
      let key = document.getElementById('scenarioSelect').value || Object.keys(state.scenarios)[0];
      if(!key) {
        key = Object.keys(SCENARIO_TEMPLATES)[0];
      }
      
      const template = state.scenarios[key] || SCENARIO_TEMPLATES[key];
      const svg = generatePhaseDiagramSVG(template, 1200, 160);
      downloadData(`${template.title.replace(/\s+/g,'_')}_diagram.svg`, svg, 'image/svg+xml');
    });

    function processTemplateToMarkdown(template) {
      let md = `# Process Design Document: ${template.title}\n\n`;
      md += `## 1. Context & Rationale\n\n`;
      md += `**Process Type:** ${template.processType}\n\n`;
      md += `**Project Context:** ${template.context}\n\n`;
      md += `**Tailoring Justification:** ${template.tailoringRationale}\n\n`;

      md += `## 2. Process Phases & Details\n\n`;
      
      template.phases.forEach((p, i) => {
        md += `### 2.${i+1} ${p.name}\n`;
        md += `- **Key Activities:** ${p.activities.join('; ')}\n`;
        md += `- **Roles:** ${(p.roles || []).join(', ')}\n`;
        md += `- **Artifacts/Deliverables:** ${(p.artifacts || []).join('; ')}\n`;
        md += `- **Decision Gates:** ${(p.gates || []).join('; ')}\n`;
        md += `- **References:** ${(p.refs || []).join(', ')}\n\n`;
      });

      md += `## 3. Referenced Standards\n\n`;
      const refs = buildReferenceList(template);
      
      if(refs.length){
        refs.forEach(r => { md += `- ${r}\n`; });
      } else {
        md += `(No specific standards referenced in this template)\n`;
      }

      md += `\n---\n_This Process Design Document was produced by the PM Standards Explorer prototype. Tailor references with precise section numbers from your uploaded standards if required._\n`;
      return md;
    }

    function buildReferenceList(template) {
      const refs = new Set();
      template.phases.forEach(p => {
        (p.refs || []).forEach(r => {
          refs.add(r);
        });
      });
      return Array.from(refs);
    }

    function generatePhaseDiagramSVG(template, width=900, height=140) {
      const phases = template.phases.map(p=>p.name);
      const n = phases.length;
      const padding = 20;
      const boxW = Math.max(120, Math.floor((width - padding*2) / n) - 12);
      const boxH = 48;
      const gap = 8;
      let x = padding;
      const y = 30;
      const svgParts = [];
      
      svgParts.push(`<svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}" viewBox="0 0 ${width} ${height}">`);
      svgParts.push(`<style>text{font-family:Arial,Helvetica,sans-serif;font-size:12px;fill:#08224a;} .box{fill:#f7fbff;stroke:#cfe3ff;stroke-width:1.2;} .arrow{stroke:#cfe3ff;stroke-width:2;fill:none;}</style>`);
      
      for(let i=0;i<n;i++){
        const px = x + (boxW+gap)*i;
        svgParts.push(`<rect class="box" x="${px}" y="${y}" rx="8" ry="8" width="${boxW}" height="${boxH}"></rect>`);
        const label = escapeHtml(phases[i]);
        const words = label.split(' ');
        let line1 = words.slice(0, Math.ceil(words.length/2)).join(' ');
        let line2 = words.slice(Math.ceil(words.length/2)).join(' ');
        svgParts.push(`<text x="${px + boxW/2}" y="${y + boxH/2 - 6}" text-anchor="middle">${line1}</text>`);
        svgParts.push(`<text x="${px + boxW/2}" y="${y + boxH/2 + 12}" text-anchor="middle">${line2}</text>`);
        
        if(i < n-1){
          const x1 = px + boxW;
          const x2 = px + boxW + gap + 6;
          const ay = y + boxH/2;
          svgParts.push(`<path class="arrow" d="M ${x1+6} ${ay} L ${x1+gap+boxW-6} ${ay}" marker-end="url(#arrowhead)"></path>`);
        }
      }
      
      svgParts.push(`<defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#cfe3ff"/></marker></defs>`);
      svgParts.push('</svg>');
      return svgParts.join('');
    }

    // ========== README Export ==========
    document.getElementById('exportReadme').addEventListener('click', () => {
      const gh = localStorage.getItem('pm_explorer_github_link') || '(not set)';
      const md = `# PM Standards Explorer ‚Äî Assignment 1\n\n**Project:** Comparative Analysis and Process Design using PM Standards Context\n\n**Authors:** Group of 3\n\n**Repository:** ${gh}\n\n## What this prototype delivers\n\n- Standards repository with upload, PDF/text parsing, and indexing.\n- Full-text search across uploaded standards using ElasticLunr.\n- Document viewer with navigation, bookmarking, and highlighting.\n- Deep links to documents and pages, with precise snippet highlighting (query + character range).\n- Bookmarking (store/open/export/import) with highlight preservation.\n- Side-by-side comparison engine (Set as A / Set as B) that highlights common phrases and shows unique terms.\n- Insights panel summarizing similarities, differences, and unique points.\n- WBS generator and Markdown export.\n- Phase 2: scenario templates (Custom Software, Innovative Product, Large Government) with phases, activities, roles, artifacts, gates, and export.\n\n_Push this file and your uploaded standards into the GitHub repo for instructor review._\n`;
      downloadData('README_Assignment1.md', md, 'text/markdown');
    });

    // ========== GitHub Link ==========
    const GITHUB_KEY = 'pm_explorer_github_link';
    document.getElementById('githubLink').addEventListener('click', (e) => {
      e.preventDefault();
      const current = localStorage.getItem(GITHUB_KEY) || '';
      const link = prompt('Enter your GitHub repository link:', current);
      if(link){
        localStorage.setItem(GITHUB_KEY, link);
        alert('GitHub repository link saved!');
      }
    });

    // ========== Initialize Application ==========
    document.getElementById('fileInput').addEventListener('change', (e) => handleFiles(e.target.files));
    
    // Set up export page button redirects
    document.querySelectorAll('#exportPage button').forEach(btn => {
      const id = btn.id;
      if (id && id !== 'exportReadme2') {
        const originalId = id.replace('2', '');
        btn.addEventListener('click', () => {
          document.getElementById(originalId).click();
        });
      }
    });
    
    document.getElementById('exportReadme2').addEventListener('click', () => {
      document.getElementById('exportReadme').click();
    });

    // Initialize bookmarks
    renderBookmarks();
  </script>
</body>
</html>